// Copyright (c) 2020-2024 Atypical Consulting SRL. All rights reserved.
// Atypical Consulting SRL licenses this file to you under the Apache 2.0 license.
// See the LICENSE file in the project root for full license information.

using System;
using System.Collections.Generic;
using System.Collections.Immutable;
using System.Linq;
using Mutty.CodeHelpers;
using Mutty.Models;

namespace Mutty.Templates;

/// <summary>
/// A template that generates the mutable wrapper for a record.
/// </summary>
/// <param name="tokens">The tokens for the record.</param>
public class MutableWrapperTemplate(RecordTokens tokens) : IndentedCodeBuilder
{
    private readonly string? _namespaceName = tokens.NamespaceName;
    private readonly string _recordName = tokens.RecordName;
    private readonly string _mutableRecordName = tokens.MutableRecordName;
    private readonly ImmutableArray<PropertyModel> _properties = tokens.Properties;

    /// <summary>
    /// Generates the code for the mutable wrapper.
    /// </summary>
    /// <returns>The generated code.</returns>
    public string GenerateCode()
    {
        CommentAutoGenerated();
        Line("using System.Collections.Immutable;");
        EmptyLine();
        if (_namespaceName is not null)
        {
            Line($"namespace {_namespaceName}");
            Braces(GenerateClass);
        }
        else
        {
            GenerateClass();
        }

        return ToString();
    }

    private void GenerateClass()
    {
        Summary($"The mutable wrapper for the <see cref=\"{_recordName}\"/> record.");
        Line($"public partial class {_mutableRecordName}");
        Braces(() =>
        {
            Line($"private {_recordName} _record;");
            GenerateConstructor();
            GenerateBuilderMethod();
            GenerateImplicitOperatorToMutable();
            GenerateImplicitOperatorToRecord();
            GenerateProperties();
        });
    }

    private void GenerateConstructor()
    {
        EmptyLine();
        Summary($"Initializes a new instance of the <see cref=\"{_mutableRecordName}\"/> class.");
        Line($"/// <param name=\"record\">The record to wrap.</param>");
        Line($"public {_mutableRecordName}({_recordName} record)");
        Braces(() =>
        {
            Line("_record = record;");
            EmptyLine();
            foreach (PropertyModel property in _properties)
            {
                switch (property.PropertyType)
                {
                    case PropertyType.ImmutableCollection:
                        {
                            Line($"{property.Name} = _record.{property.Name}.AsMutable();");
                            break;
                        }
                    default:
                        {
                            Line($"{property.Name} = _record.{property.Name};");
                            break;
                        }
                }
            }
        });
    }

    private void GenerateBuilderMethod()
    {
        EmptyLine();
        Summary($"Builds a new instance of the <see cref=\"{_recordName}\"/> class.");
        Line($"public {_recordName} Build()");
        Braces(() =>
        {
            Line("return _record with");
            Braces(
                () =>
                {
                    foreach (PropertyModel property in _properties)
                    {
                        switch (property.PropertyType)
                        {
                            case PropertyType.Record:
                                {
                                    Line($"{property.Name} = this.{property.Name},");
                                    break;
                                }
                            case PropertyType.ImmutableCollection:
                                {
                                    Line($"{property.Name} = this.{property.Name}.ToImmutable(),");
                                    break;
                                }
                            case PropertyType.Other:
                                {
                                    Line($"{property.Name} = this.{property.Name},");
                                    break;
                                }
                            default:
                                throw new ArgumentOutOfRangeException();
                        }
                    }
                },
                ";");
        });
    }

    private void GenerateProperties()
    {
        foreach (PropertyModel property in _properties)
        {
            EmptyLine();

            switch (property.PropertyType)
            {
                case PropertyType.Record:
                    {
                        GenerateNestedMutableProperty(property);
                        break;
                    }
                case PropertyType.ImmutableCollection:
                    {
                        GenerateCollectionProperty(property);
                        break;
                    }
                case PropertyType.Other:
                    {
                        GenerateSimpleProperty(property);
                        break;
                    }
                default:
                    throw new ArgumentOutOfRangeException();
            }
        }
    }

    private void GenerateSimpleProperty(PropertyModel property)
    {
        Summary($"Gets or sets the {property.Name}.");
        Line($"public {property.Type} {property.Name} {{ get; set; }}");
    }

    private void GenerateNestedMutableProperty(PropertyModel property)
    {
        string mutableTypeName = $"Mutable{property.Type.Split('.').Last()}";
        string propertyType = property.PropertyType.ToString();

        Summary($"Gets or sets the {propertyType} {property.Name}.");
        Line($"public {mutableTypeName} {property.Name} {{ get; set; }}");
    }

    private void GenerateCollectionProperty(PropertyModel property)
    {
        string mutableType = ConvertImmutableToMutable(property.Type);
        string mutableItemType = GetMutableItemType(property.Type);
        string propertyType = property.PropertyType.ToString();

        Summary($"Gets or sets the {propertyType} {property.Name}.");
        Line($"public {mutableType}<Mutable{mutableItemType}> {property.Name} {{ get; set; }}");
    }

    private string ConvertImmutableToMutable(string immutableType)
    {
        Dictionary<string, string> immutableMap = [];
        immutableMap.Add("System.Collections.Immutable.ImmutableArray", "List");
        immutableMap.Add("System.Collections.Immutable.ImmutableDictionary", "Dictionary");
        immutableMap.Add("System.Collections.Immutable.ImmutableHashSet", "HashSet");
        immutableMap.Add("System.Collections.Immutable.ImmutableList", "List");
        immutableMap.Add("System.Collections.Immutable.ImmutableQueue", "Queue");
        immutableMap.Add("System.Collections.Immutable.ImmutableSortedDictionary", "SortedDictionary");
        immutableMap.Add("System.Collections.Immutable.ImmutableSortedSet", "SortedSet");
        immutableMap.Add("System.Collections.Immutable.ImmutableStack", "Stack");

        // use immutableMap and StartsWith
        foreach (KeyValuePair<string, string> pair in immutableMap)
        {
            string key = pair.Key;
            string value = pair.Value;

            if (immutableType.StartsWith(key, StringComparison.Ordinal))
            {
                return value;
            }
        }

        // Handle other types as needed
        return immutableType;
    }

    private string GetMutableItemType(string immutableType)
    {
        int genericTypeIndex = immutableType.IndexOf('<');
        if (genericTypeIndex > 0)
        {
            string itemType = immutableType.Substring(genericTypeIndex + 1, immutableType.Length - genericTypeIndex - 2);
            return itemType.Split('.').Last();
        }

        return immutableType;
    }

    private void GenerateImplicitOperatorToMutable()
    {
        EmptyLine();
        Summary($"Performs an implicit conversion from <see cref=\"{_recordName}\"/> to <see cref=\"{_mutableRecordName}\"/>.");
        Line($"public static implicit operator {_mutableRecordName}({_recordName} record)");
        Braces(() => Line($"return new {_mutableRecordName}(record);"));
    }

    private void GenerateImplicitOperatorToRecord()
    {
        EmptyLine();
        Summary($"Performs an implicit conversion from <see cref=\"{_mutableRecordName}\"/> to <see cref=\"{_recordName}\"/>.");
        Line($"public static implicit operator {_recordName}({_mutableRecordName} mutable)");
        Braces(() => Line("return mutable.Build();"));
    }
}
